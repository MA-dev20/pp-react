<div class="files" style="<%= @files.count == 0 ? 'display: none' : 'display: block' %>">
  <h3>Dateien</h3>

  <% @files.each do |f| %>
    <div class="background-blur file-modal file-modal-bg" id="edit_content<%= f.id %>">
      <div class="content-popup">
        <% content = f %>
        <%= image_tag 'icons/close.svg', class: 'close', onclick: 'closeMediaModal()' %>
          <div class="form-group">
            <% if can? :edit, content %>
              <input value="<%= content.title %>" class="form-field title-field" type="text">
            <% else %>
              <h3><%= content.title %></h3>
            <% end %>
          </div>
          <% if content.media_type == 'image' && content.image.url.present? %>
            <%= image_tag content.image.url %>
          <% elsif content.media_type == 'video' && content.video.url.present? %>
            <%= video_tag content.video.url, controls: true, id: 'content_media'%>
          <% elsif content.media_type == 'audio' && content.audio.url.present? %>
            <div class="audio">
              <%= image_tag 'dash/audio.png' %>
              <%= audio_tag content.audio.url, controls: true, id: 'content_media' %>
            </div>
          <% elsif content.media_type == 'pdf' %>
            <div class="audio">
              <iframe src="<%= content.pdf.url %>" width="100%" height="500px"></iframe>
            </div>
          <% end %>
          <% if can? :edit, content %>
            <div class="btns">
              <div class="btn inverted" onclick='closeMediaModal()'>Cancel</div>
              <input type="submit" name="commit" value="speichern" class="btn submit-btn" data-disable-with="speichern">
            </div>
          <% end %>
      </div>
    </div>
    <% if f.audio? || f.image? || f.video? || f.pdf? %>
    <div class="card" id='media_<%= f.id %>'>
      <% if (can? :edit, f) && !current_page?(dashboard_peters_content_path) %>
      <div class="dropdown">
        <i class="fas fa-ellipsis-v dropdown-icon" aria-hidden="true" onclick="toggleDropdownContent(this)"></i>
        <div class="dropdown-Menu">
          <div class="point" data-type="<%= f.media_type %>" data-id="<%= f.id %>" onclick="showMediaModal(this)">
            <i class="fa fa-pencil-alt"></i>Bearbeiten
          </div>
          <% if controller.controller_name != "backoffice" %>
          <div class="point" data-type="<%= f.media_type %>" data-id="<%= f.id %>" onclick="shareMedia(this)">
            <i class="fa fa-share-alt"></i>Freigeben
          </div>
          <% end %>
          <div class="point" data-type="<%= f.media_type %>" data-id="<%= f.id %>" onclick="deleteContent(this)">
            <%= image_tag 'dash/new_icons/trash.svg', class: 'delete' %>Löschen
          </div>
        </div>
      </div>
      <% end %>
      <div class="thumb" data-type="<%= f.media_type %>" data-id="<%= f.id %>" onclick="showMediaModal(this)">
          <% if f.media_type == 'video' %>
            <%= image_tag f.video.thumb.url, class: 'image' %>
            <i class="fas fa-play-circle"></i>
          <% elsif f.media_type == 'image' %>
            <%= image_tag f.image.url, class: 'image' %>
          <% elsif f.media_type == 'audio' %>
            <div class="list-icon">
              <%= image_tag 'dash/audio.png' %>
            </div>
            <%= image_tag 'dash/placeholder.png', class: 'image' %>
          <% elsif f.media_type == 'pdf' %>
            <div class="list-icon">
              <%= image_tag 'dash/import-PDF.png' %>
            </div>
            <%= image_tag 'dash/placeholder.png', class: 'image' %>
          <% end %>

      </div>
      <div class="text">
          <div class="title" id="media_title_<%= f.id %>"><%= f.title %><div class="ellipsis">...</div></div>
          <% if f.media_type == 'video' %>
          <div class="time"><%= image_tag 'dash/video-icon.png' %><%= (f.duration / 60).to_s + ':' + (f.duration % 60 < 10 ? '0' + (f.duration % 60).to_s : (f.duration % 60).to_s) %> - <%= f.user ? f.user.fname[0] + '. ' + f.user.lname : 'Gelöschter Nutzer' %></div>
          <% elsif f.media_type == 'audio' %>
          <div class="time"><%= image_tag 'dash/audio.png' %><%= (f.duration / 60).to_s + ':' + (f.duration % 60 < 10 ? '0' + (f.duration % 60).to_s : (f.duration % 60).to_s) %> - <%= f.user ? f.user.fname[0] + '. ' + f.user.lname : 'Gelöschter Nutzer' %></div>
          <% elsif f.media_type == 'pdf' %>
          <div class="time"><%= image_tag 'dash/import-PDF.png' %><%= f.user ? f.user.fname[0] + '. ' + f.user.lname : 'Gelöschter Nutzer' %></div>
          <% else %>
          <div class="time"><%= image_tag 'dash/image-icon.png' %><%= f.user ? f.user.fname[0] + '. ' + f.user.lname : 'Gelöschter Nutzer' %></div>
          <% end %>
      </div>

    </div>
    <script type="text/javascript">
      checkOverflow('media_title_<%= f.id %>');
    </script>
    <% end %>
  <% end %>
</div>
<script type="text/javascript">
  function shareMedia(e) {
    var type = $(e).attr('data-type');
		var mediaID = $(e).attr('data-id');
    <% if params[:folder_id] %>
      location.replace('?folder_id=<%= params[:folder_id] %>&share_content='+mediaID);
    <% else %>
    location.replace('?share_content='+mediaID);
    <% end %>
  }
  function deleteContent(e) {
		var type = $(e).attr('data-type');
		var mediaID = $(e).attr('data-id');
    var URL = '/task_medium/'+mediaID+'/delete';
		$.ajax({
			url: URL,
			type: 'put',
			beforeSend: function (xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
			success: function(res) {
				if( res.id ) {
					$('#media_' + res.id).hide();
				} else if (res.error) {
          if ( $('.modal-blur').length > 0 ) {
            $('.modal-blur').remove();
          }
					var userDiv = '<div class="modal-blur"><div class="modal card"><div class="close" onclick="toggleModal()"><%= image_tag 'icons/close.svg' %></div><h3>Fehler!</h3>'+res.error;
          userDiv += '<div class="btns"><div class="btn" data-type="'+type+'" data-id="'+mediaID+'" onclick="deleteforceContent(this)">trotzdem löschen</div></div></div></div>';
					$('body').append(userDiv);
				}
			}
		})
	}
  function deleteforceContent(e) {
		var type = $(e).attr('data-type');
		var mediaID = $(e).attr('data-id');
    var URL = '/task_medium/'+mediaID+'/delete_force';
		$.ajax({
			url: URL,
			type: 'put',
			beforeSend: function (xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
			success: function(res) {
				if( res.id ) {
					$('#media_' + res.id).hide();
          $('.modal-blur').remove();
				}
			}
		})
	}
</script>
