<% if params[:share_list] %>
  <% this_list = List.find(params[:share_list]) %>
<div class="background-blur" id="shareList" style="display: block">
  <div class="content-popup">
    <%= image_tag 'icons/close.svg', class: 'close', onclick: 'closeShareList()' %>
    <h3>Liste teilen mit:</h3>
    <%= form_for :list, url: share_list_path(this_list), html: {id: 'shareForm'} do |f| %>
    <%= f.hidden_field :available_for, value: this_list.available_for %>
    <%= f.hidden_field :team_id, value: this_list.team_id %>
    <%= f.hidden_field :department_id, value: this_list.department_id %>
    <div class="form-group list-table">
      <label for="">E-Mail eingeben</label>
      <%= f.text_field :email, placeholder: 'E-Mail eingeben', class: 'form-field' %>
    </div>
    <div class="form-group list-table">
      <label for="">Gruppe ausw√§hlen</label>
      <div class="dropdown" id="ability-dropdown">
        <div class="dropdown-text" onclick="showDropdown()"><span><%= this_list.available_for == 'user' ? "Teilen mit: " : this_list.available_for == 'team' ? "Geteilt mit Team: " + Team.find(this_list.team_id).name : this_list.available_for == 'company' ? 'Geteilt mit Company' : this_list.available_for == 'global' ? 'Global Content' : this_list.available_for == 'global_hidden' ? 'Globaler Hidden Content' : '' %></span><i class="fas fa-caret-down"></i></div>
        <div class="dropdown-menu" id="userDropdown">
          <% if @admin.bo_role == 'root' %>
          <div class="link" onclick="shareBig('global_hidden')">
            Global Hidden
          </div>
            <div class="link" onclick="shareBig('global')">
              Global
            </div>
          <% end %>
          <div class="link" onclick="shareBig('company')">
            <%= @company.name %>
          </div>
          <% if @admin.teams.count != 0 %>
          <div class="link">
            Team<span>></span>
            <div class="teams">
              <% @admin.teams.each do |t| %>
              <div class="link" onclick="shareTeam('<%= t.id %>', '<%= t.name %>')">
                <%= t.name %>
              </div>
              <% end %>
            </div>
          </div>
          <% end %>
        </div>
      </div>
    </div>
    <div class="btns">
      <div class="btn inverted" onclick='closeShareList()'>Abbrechen</div>
      <%= f.submit 'teilen', class: 'btn' %>
    </div>
    <% end %>
  </div>
</div>
<script type="text/javascript">
  function showDropdown() {
    $('#userDropdown').toggle();
  }
  function shareBig(type) {
    $('#list_available_for').val(type);
    if( type == 'company' ) {
      $('.dropdown-text span').text("<%= @company.name %>");
    } else if (type == 'global_hidden') {
      $('.dropdown-text span').text("Globaler Hidden Content");
    } else if (type == 'global') {
      $('.dropdown-text span').text("Globaler Content");
    }
    $('#userDropdown').toggle();
  }
  function shareTeam(teamID, teamName) {
    $('#list_available_for').val('team');
    $('#list_team_id').val(teamID);
    $('.dropdown-text span').text("Team: "+teamName);
    $('#userDropdown').toggle();
  }
  function closeShareList() {
    $('#shareList').hide();
  }
  $('#shareForm').on('submit', function(e) {
    e.preventDefault();
    var URL = '<%= share_list_path(this_list) %>';
    var formData = new FormData(document.getElementById('shareForm'));
    $.ajax({
      url: URL,
      type: 'post',
      cache: false,
    	async: true,
    	contentType: false,
    	processData: false,
      data: formData,
    	beforeSend: function (xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
    	success: function (res) {
        if( res.success ) {
          alert(res.success);
          closeShareList();
        } else if ( res.new_users ) {
          location.replace('?new_users=true')
        } else if ( res.error ){
          alert(res.error);
        }
  		}
    })
})
</script>
<% end %>
