<div class="background-blur" id="new-content">
  <div class="content-popup">
    <%= image_tag 'icons/close.svg', class: 'close', onclick: 'newContent()' %>
    <h3>Inhalte hinzufügen</h3>
    <h5>Hier kannst du Bild, Video, Audio oder PDF-Dateien hochladen</h5>
    <div class="preview"></div>
    <div class="droparea">
      <div class="info">Datei hier hinziehen</div>
      <input type="file" name="" value="" id="file_upload_field">
      <label for="file_upload_field">
        <div class="btn inverted">Upload vom Computer</div>
      </label>

    </div>
    <%= form_for :task_medium, url: create_media_path, html: {id: 'media-form'} do |f| %>
    <%= f.hidden_field :media_type, value: '' %>
    <%= f.hidden_field :audio %>
    <%= f.hidden_field :content_folder_id, value: params[:folder_id] ? params[:folder_id] : nil %>
    <%= f.file_field :image %>
    <%= f.file_field :pdf %>
    <%= f.file_field :video %>
    <div class="form-group">
      <%= f.text_field :title, class: 'form-field', placeholder: 'Dateiname hier eingeben' %>
    </div>
    <div class="btns">
      <div class="btn inverted" onclick="newContent()">Abbrechen</div>
      <div class="btn" onclick="submitContent()">Speichern</div>
    </div>
    <% end %>
  </div>
</div>
<div class="popup" id="popup">
	<div class="img-container">
		<%= image_tag '', id: 'user_image' %>
	</div>
   	<div class="center">
    	<div class="btn btn-green" id="crop">speichern</div>
   	</div>
   	<div class="close" onclick="hidePopup()"><%= image_tag 'icons/close.svg' %></div>
</div>
<script>
  var files;
  var image_file;
  function newContent() {
    $('#new-content').toggle();
    $('.droparea').show();
    $('.preview').text('');
  }
  function newContentType(type) {
    location.replace('?new=' + type);
  }
  <% if params[:new] %>
    toggleNewContent();
    newContent();
  <% end %>
  var DropZone = $('.droparea')
	DropZone.on('drag dragstart dragend dragover dragenter dragleave drop', function (e) {
		e.preventDefault();
		e.stopPropagation();
	})
	DropZone.on('dragover dragenter', function () {
		$(this).addClass('dragover');
	})
	DropZone.on('dragleave dragend drop', function () {
		$(this).removeClass('dragover');
	})

	DropZone.on('drop', function (e) {
		files = e.originalEvent.dataTransfer.files;
    handleFiles();
	});
  $('#file_upload_field').on('change', function(e) {
    files = e.target.files;
    handleFiles();
  })
  function handleFiles() {
    if (files[0]['type'].split('/')[0] === 'audio') {
      $('#task_medium_media_type').val('audio');
      var userDiv = '<div class="audio"><%= image_tag 'dash/audio.png' %></div>';
      $('.droparea').hide();
      $(".preview").prepend(userDiv);
      var sound = document.createElement('audio');
      sound.controls = 'controls';
      sound.src = URL.createObjectURL(files[0]);
      $('.audio').append(sound);
		} else if (files[0]['type'].split('/')[0] === 'image') {
      $('#task_medium_media_type').val('image');
      $('.droparea').hide();
      crop(URL.createObjectURL(files[0]));
    } else if (files[0]['type'].split('/')[0] === 'video') {
      $('#task_medium_media_type').val('video');
      $('.droparea').hide();
      var video = document.createElement('video');
      video.controls = 'controls';
      video.src = URL.createObjectURL(files[0]);
      $('.preview').append(video);
    } else if (files[0]['type'].split('/')[1] === 'pdf') {
      $('#task_medium_media_type').val('pdf');
      var userDiv = '<div class="audio"><%= image_tag 'dash/import-PDF.png' %></div>';
      $('.droparea').hide();
      $(".preview").prepend(userDiv);
    } else {
      $('#task_medium_media_type').val('invalid');
      $('.droparea').hide();
      var userDiv = '<div class="audio"><i class="fas fa-exclamation-triangle"></i>Ungültiges Format!</div>';
      $(".preview").prepend(userDiv);
    }
  }
  $("#media-form").on('submit', function(e) {
    e.preventDefault();
    submitContent();
  })
  function submitContent() {
    <% if controller.controller_name == "backoffice" && controller.action_name == 'content' %>
    var URL = "<%= create_global_media_path %>";
    <% else %>
    var URL = "<%= create_media_path %>";
    <% end %>
    var formData = new FormData(document.getElementById('media-form'));
    if ( $('#task_medium_media_type').val() == 'audio' ) {
      formData.append( $('#task_medium_audio').attr('name'), files[0] );
    } else if ( $('#task_medium_media_type').val() == 'image' ) {
      formData.append( $('#task_medium_image').attr('name'), image_file );
    } else if ( $('#task_medium_media_type').val() == 'video' ) {
      formData.append( $('#task_medium_video').attr('name'), files[0] );
    } else if ( $('#task_medium_media_type').val() == 'pdf' ) {
      formData.append( $('#task_medium_pdf').attr('name'), files[0] );
    } else {
      alert('Ungültiger Dateityp');
      return;
    }
    $.ajax({
      url: URL,
      type: 'post',
      data: formData,
      cache: false,
      contentType: false,
      processData: false,
      beforeSend: function (xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
      success: function(res) {
        if( res.no_title ) {
          $('#task_medium_title').val('');
          $('#task_medium_title').css("border-color", 'red');
          formData = new FormData();
        } else {
          location.reload();
        }
      }
    })
  }

  // cropper
  function showPopup() {
    $('#popup').show();
  }
  function hidePopup() {
    $('#popup').hide();
  }
	(function ($) {
	  $.each(['show', 'hide'], function (i, ev) {
	    var el = $.fn[ev];
	    $.fn[ev] = function () {
	      this.trigger(ev);
	      return el.apply(this, arguments);
	    };
	  });
  })(jQuery);
  var image = document.getElementById('user_image');
  function crop(src) {
    image.src = src;
    $('#popup').show();
  }
  $('#popup').on('show', function() {
    if(cropper) {
      cropper.destroy();
    }
		cropper = new Cropper(image, {
			aspectRatio: 1.77,
		});
	})
  $('#popup').on('hide', function() {
    if(cropper) {
      cropper.destroy();
      cropper = null;
    }
	})
  $('#crop').on('click', function() {
		var initialURL, canvas;
		if(cropper) {
			canvas = cropper.getCroppedCanvas({
				fillColor: "white",
        maxWidth: 1920,
        maxHeight: 1080,
			});
      var preview = document.createElement('img');
      preview.src = canvas.toDataURL();
      $('.preview').append(preview);
			canvas.toBlob(function(blob) {
        var URL = "<%= create_media_path %>";
				var date = new Date().getTime();
				image_file = new window.File([blob], 'avatar_'+date+'.jpg', {type: 'image/jpg'});
			});
      $('#popup').hide();
		};
	})
</script>
