<% if params[:share_content] %>
<% this_media = TaskMedium.find(params[:share_content]) %>
<div class="background-blur" id="shareContent" style="display: block">
  <div class="content-popup">
    <%= image_tag 'icons/close.svg', class: 'close', onclick: 'closeShareContent()' %>
    <h3>Content teilen mit:</h3>
    <%= form_for :content, url: share_content_path(this_media), html: {id: 'shareForm'} do |f| %>
    <%= f.hidden_field :available_for, value: this_media.available_for %>
    <%= f.hidden_field :team_id, value: this_media.team_id %>
    <div class="form-group list-table">
      <label for="">E-Mail eingeben. (Um mehrere E-Mail Adressen einzugeben, trenne sie durch Leerzeichen)</label>
      <%= f.text_field :email, placeholder: 'mustermann@peterpitch.com', class: 'form-field' %>
    </div>
    <div class="form-group list-table">
      <label for="">oder freigeben f√ºr</label>
      <div class="dropdown" id="ability-dropdown">
        <div class="dropdown-text" onclick="showDropdown()"><span><%= this_media.available_for == 'user' ? "Teilen mit: " : this_media.available_for == 'team' ? "Geteilt mit Team: " + Team.find(this_media.team_id).name : this_media.available_for == 'company' ? 'Geteilt mit Company' : 'Global Content' %></span><i class="fas fa-caret-down"></i></div>
        <div class="dropdown-menu" id="userDropdown">
          <% if @admin.bo_role == 'root' %>
            <div class="link" onclick="shareBig('global_hidden')">
              Global hidden
            </div>
            <div class="link" onclick="shareBig('global')">
              Global
            </div>
          <% end %>
          <div class="link" onclick="shareBig('company')">
            <%= @company.name %>
          </div>
          <% if @admin.teams.count != 0 %>
          <div class="link">
            Team<span>></span>
            <div class="teams">
              <% @admin.teams.each do |t| %>
              <div class="link" onclick="shareTeam('<%= t.id %>', '<%= t.name %>')">
                <%= t.name %>
              </div>
              <% end %>
            </div>
          </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="btns">
      <div class="btn inverted" onclick='closeShareContent()'>Abbrechen</div>
      <%= f.submit 'teilen', class: 'btn' %>
    </div>
    <% end %>
  </div>
</div>
<script type="text/javascript">
  function showDropdown() {
    $('#userDropdown').toggle();
  }
  function shareBig(type) {
    $('#content_available_for').val(type);
    if( type == 'company' ) {
      $('.dropdown-text span').text("<%= @company.name %>");
    } else if (type == 'global_hidden') {
      $('.dropdown-text span').text("Globaler Hidden Content");
    } else if (type == 'global') {
      $('.dropdown-text span').text("Globaler Content");
    }
    $('#userDropdown').toggle();
  }
  function shareTeam(teamID, teamName) {
    $('#content_available_for').val('team');
    $('#content_team_id').val(teamID);
    $('.dropdown-text span').text("Team: "+teamName);
    $('#userDropdown').toggle();
  }
  function closeShareContent() {
    $('#shareContent').hide();
  }
  $('#shareForm').on('submit', function(e) {
    e.preventDefault();
    var URL = '<%= share_content_path(this_media) %>';
    var userData = new FormData(document.getElementById('shareForm'));
    $.ajax({
      url: URL,
      type: 'post',
      cache: false,
    	async: true,
    	contentType: false,
    	processData: false,
      data: userData,
    	beforeSend: function (xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
    	success: function (res) {
        if( res.success ) {
          alert(res.success);
          closeShareContent();
        } else if ( res.new_users ) {
          location.replace('?new_users=true')
        } else if ( res.error ){
          alert(res.error);
        }
  		}
    })
  })
</script>
<% end %>
